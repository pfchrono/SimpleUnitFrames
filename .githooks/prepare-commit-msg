#!/usr/bin/env bash
set -euo pipefail

MSG_FILE="${1:-}"
SOURCE="${2:-}"

if [[ -z "$MSG_FILE" ]]; then
	exit 0
fi

# Respect merge/squash/commit --amend defaults and any existing message text.
if [[ "$SOURCE" == "merge" || "$SOURCE" == "squash" || "$SOURCE" == "commit" ]]; then
	exit 0
fi
if [[ -s "$MSG_FILE" ]]; then
	exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPT_PATH="$REPO_ROOT/scripts/generate-commit-message.ps1"

if [[ ! -f "$SCRIPT_PATH" ]]; then
	exit 0
fi

if command -v pwsh >/dev/null 2>&1; then
	pwsh -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT_PATH" -OutputFile "$MSG_FILE"
elif command -v powershell >/dev/null 2>&1; then
	powershell -NoProfile -ExecutionPolicy Bypass -File "$SCRIPT_PATH" -OutputFile "$MSG_FILE"
fi
